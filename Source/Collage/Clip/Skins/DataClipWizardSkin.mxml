<?xml version="1.0" encoding="utf-8"?>
<s:Skin xmlns:fx="http://ns.adobe.com/mxml/2009"
		xmlns:clgdata="Collage.DataEngine.*"
		xmlns:clgclip="Collage.Clip.*"
		xmlns:s="library://ns.adobe.com/flex/spark" 
        xmlns:fb="http://ns.adobe.com/flashbuilder/2009"
	    xmlns:mx="library://ns.adobe.com/flex/mx"
		width="100%" height="100%">
    <fx:Metadata>
        <![CDATA[ 
        [HostComponent("Collage.Clip.DataClipWizard")]
        ]]>
    </fx:Metadata> 
	<fx:Script><![CDATA[
		import Collage.Application.*;
		import Collage.DataEngine.*;
		import Collage.Utilities.Logger.*;
		
		private function DataSetSelected():void
		{
			currentState = "page2";
			if (dataSetsList.selectedItem) {
				if (hostComponent.query.dataset != (dataSetsList.selectedItem as DataSet).id) {
					hostComponent.query.dataset = (dataSetsList.selectedItem as DataSet).id;
					
					for (var i:int = 0; i < hostComponent.queryDefinition.fieldDefinitions.length; i++)	{
						hostComponent.queryDefinition.fieldDefinitions.getItemAt(i)['selectedColumn'] = null;
					}
				}
			}
			
			columnsDataGroup.dataProvider = null;
			columnsDataGroup.dataProvider = hostComponent.queryDefinition.fieldDefinitions;
			hostComponent.queryDefinition.selectedDataSetID = hostComponent.query.dataset;
			
			Logger.LogDebug("Selected Dataset: " + hostComponent.query.dataset, hostComponent)
		}
		
		private function Submit():void
		{
			Logger.LogDebug("Submit Selected Dataset: " + hostComponent.query.dataset, hostComponent)
			hostComponent.query.ResetFields();
			
			for (var i:int = 0; i < hostComponent.queryDefinition.fieldDefinitions.length; i++)	{
				var queryFieldDef:QueryFieldDefinition = hostComponent.queryDefinition.fieldDefinitions.getItemAt(i) as QueryFieldDefinition;
				if (!queryFieldDef || !queryFieldDef.selectedColumn) {
					columnSelectionError.visible = true;
					return;
				}
				
				var groupType:String = null;
				if (queryFieldDef.grouped)
					groupType = "val";
				
				var sortType:String = null;
				if (queryFieldDef.sortDirection)
					sortType = queryFieldDef.sortDirection;
				
				var modifierType:String = null;
				if (queryFieldDef.selectedModifier)
					modifierType = queryFieldDef.selectedModifier;
				
				Logger.LogDebug("Submit Selected Column: " + queryFieldDef.title + " : " + queryFieldDef.selectedColumn, hostComponent)
				hostComponent.query.AddField(queryFieldDef.internalName, queryFieldDef.selectedColumn, sortType, modifierType, groupType);
			}

			columnSelectionError.visible = false;
			hostComponent.query.LoadQueryResults();
			CollageApp.instance.ClosePopup("datawizard");
		}
		
	]]></fx:Script>
    <s:states>
        <s:State name="normal" />
        <s:State name="page2" />
        <s:State name="disabled" />
    </s:states>
    <s:layout>
        <s:BasicLayout/>
    </s:layout>
	<s:Group left="15" right="15" top="15" bottom="15" includeIn="normal">
		<s:Label text="Step 1: Choose a dataset" top="0" left="0" fontSize="18" color="#eeeeee" />
		<clgdata:DataSetsList id="dataSetsList" width="100%" top="35" bottom="40" left="10"/>
		<s:HGroup bottom="0" right="0">
			<s:Button id="Page1NextButton" right="0" click="DataSetSelected()" label="Next" enabled="{(dataSetsList.selectedItem)?true:false}" />
		</s:HGroup>
	</s:Group>
	<s:Group left="15" right="15" top="15" bottom="15" includeIn="page2">
		<s:Label text="Step 2: Choose Columns" fontSize="18" color="#eeeeee" top="0" left="0" />
		<clgclip:DataClipWizardColumnsList id="columnsDataGroup" width="100%" left="10" top="35" bottom="80" />
		<s:HGroup bottom="40" right="0" includeInLayout="{hostComponent.queryDefinition.maxRowsReturned!=hostComponent.queryDefinition.minRowsReturned}" visible="{hostComponent.queryDefinition.maxRowsReturned!=hostComponent.queryDefinition.minRowsReturned}">
			<s:Label text="How many rows?" color="#eeeeee" fontSize="12" />
			<s:NumericStepper value="@{hostComponent.query.limit}" stepSize="1" maximum="{hostComponent.queryDefinition.maxRowsReturned}" minimum="{hostComponent.queryDefinition.minRowsReturned}" />
		</s:HGroup>
		<s:HGroup bottom="0" right="0">
			<s:Label id="columnSelectionError" visible="false" text="Please select all data columns" color="#ff0000" fontSize="14" />
			<s:Button id="Page2PrevButton" right="0" click="currentState = 'normal'" label="Back to Datasets" />
			<s:Button id="SubmitButton" right="0" click="Submit()" label="Submit" />
		</s:HGroup>
	</s:Group>
</s:Skin>
